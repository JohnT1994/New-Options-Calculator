<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Options Probability Calculator | MASSIVE QUANT PRO</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1"></script>
  <style>
    :root { 
      --primary: #007bff; --success: #28a745; --accent: #6f42c1; --danger: #ff4d4d; --warning: #ffcc00;
      --glass: rgba(0, 0, 0, 0.93); 
    }
    body { 
      font-family: 'Segoe UI', sans-serif; background-image: url('https://i.imgur.com/nVWumk7.png'); 
      background-size: cover; background-position: center; background-attachment: fixed;
      color: #ffffff; max-width: 1100px; margin: 2rem auto; padding: 0 1rem; 
    }
    .container { 
      background: var(--glass); backdrop-filter: blur(15px); padding: 2.5rem; border-radius: 20px; 
      border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 12px 50px rgba(0,0,0,0.8);
    }
    .vix-banner {
      display: flex; justify-content: space-between; align-items: center;
      background: linear-gradient(90deg, rgba(111, 66, 193, 0.1), rgba(0, 123, 255, 0.1));
      padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .vix-val { font-size: 1.5rem; font-weight: bold; color: #a282e8; }
    .grid-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.2rem; }
    .ticket-row { display: flex; gap: 0.5rem; align-items: flex-end !important; grid-column: span 2; }
    label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.85rem; color: #bbb; }
    input, select { 
      width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 8px; 
      background: #ffffff; color: #000000; font-size: 0.95rem; box-sizing: border-box;
    }
    button { padding: 0.8rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-fetch { background: var(--success); color: white; }
    .btn-calc { background: var(--primary); color: white; width: 100%; font-size: 1.1rem; grid-column: span 2; margin-top: 10px; }
    .picker-btn { display:block; width:100%; margin:5px 0; padding:10px; background:#333; color:white; border:1px solid #555; border-radius:6px; cursor:pointer; text-align: left; }
    #results { margin-top: 2.5rem; display: none; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 2rem; }
    
    #executionSignal { 
      padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center; 
      font-size: 1.2rem; font-weight: 800; display: none; border-left: 10px solid;
    }
    .sig-green { background: rgba(40, 167, 69, 0.2); border-color: var(--success); color: #8bff99; }
    .sig-yellow { background: rgba(255, 204, 0, 0.1); border-color: var(--warning); color: var(--warning); }
    .sig-red { background: rgba(255, 77, 77, 0.2); border-color: var(--danger); color: #ffb3b3; }

    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .summary-item { background: rgba(255, 255, 255, 0.05); padding: 1.2rem; border-radius: 12px; border-left: 4px solid var(--primary); }
    .greeks-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.6rem; }
    .greek-card { background: rgba(255, 255, 255, 0.08); padding: 1rem 0.5rem; border-radius: 10px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); }
    .greek-name { font-size: 0.7rem; color: #4db8ff; font-weight: bold; display: block; margin-bottom: 4px; }
    .help { cursor: pointer; background: #4db8ff; color: #fff; border-radius: 50%; padding: 0 5px; font-size: 0.7rem; margin-left: 4px; }
  </style>
</head>
<body>

<div class="container">
  <div class="vix-banner">
    <div>
      <div style="font-size: 0.65rem; color: #888; text-transform: uppercase;">Live Market Macro</div>
      <div id="vixTime" style="font-size: 0.75rem; color: #aaa;">Syncing...</div>
    </div>
    <div style="text-align: right;">
      <div>VIX: <span id="vixVal" class="vix-val">--</span></div>
      <div>10Y Yield: <span id="tnxVal" style="color:var(--success); font-weight:bold;">--</span>%</div>
    </div>
  </div>

  <h1 style="text-align:center; margin-top:0; letter-spacing: 1px;">Options Probability Calculator</h1>

  <form id="optionForm" class="grid-form">
    <div class="ticket-row">
      <div style="flex: 1;">
        <label>Ticker Symbol</label>
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
            <img id="stockLogo" style="width: 24px; height: 24px; display: none; border-radius: 4px;">
            <span id="companyName" style="font-size: 0.8rem; color: #aaa;"></span>
        </div>
        <input type="text" id="symbol" placeholder="AAPL" oninput="cachedChain=null" />
      </div>
      <button type="button" class="btn-fetch" onclick="fetchMassiveLastTrade()">Fetch Price</button>
    </div>

    <div><label>Stock Price ($)</label><input type="number" id="stockPrice" step="0.01" /></div>
    <div><label>Contracts</label><input type="number" id="qty" value="1" /></div>
    
    <div>
      <label>Expiration <span id="dteLabel" style="color:var(--warning); font-size:0.75rem; font-weight:bold;"></span></label>
      <div style="display: flex; gap: 5px;">
        <input type="text" id="expiry" placeholder="YYYY-MM-DD" readonly />
        <button type="button" onclick="pickMassiveExpiry()" style="background:#444; color:white;">Pick</button>
      </div>
    </div>

    <div>
      <label>Strike Price</label>
      <div style="display: flex; gap: 5px;">
        <input type="number" id="strike" step="0.01" />
        <button type="button" onclick="pickMassiveStrike()" style="background:#444; color:white;">Pick</button>
      </div>
    </div>

    <div><label>Option Type</label><select id="type"><option value="call">Call</option><option value="put">Put</option></select></div>
    <div><label>IV (%)</label><input type="number" id="iv" step="0.01" /></div>
    <div><label>Paid Premium (Entry)</label><input type="number" id="paidPremium" step="0.01" style="border:1.5px solid var(--success);" /></div>
    <div><label>Current Premium (Market)</label><input type="number" id="currentPremium" step="0.01" /></div>

    <button type="button" class="btn-calc" onclick="runAnalysis()">Run 100,000 Path Analysis</button>
  </form>

  <div id="results">
    <div id="executionSignal"></div>
    <div class="summary-grid">
      <div class="summary-item"><label>Monte Carlo Prob.</label><div id="mcProb" style="font-weight:bold; font-size:1.3rem;">--</div></div>
      <div class="summary-item"><label>Prob. of Profit (BSM)</label><div id="pop">--</div></div>
      <div class="summary-item"><label>Breakeven (Paid)</label><div id="resBreak">--</div></div>
      <div class="summary-item"><label>Total Entry Cost</label><div id="resCost">--</div></div>
    </div>
    
    <div style="height: 450px; background: rgba(0,0,0,0.4); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.1);">
        <canvas id="payoffChart"></canvas>
    </div>

    <div class="greeks-grid" style="margin-top:20px;">
      <div class="greek-card"><span class="greek-name">DELTA <span class="help" onclick="alert('Price Sensitivity: Per $1 stock move')">?</span></span><div id="d">--</div></div>
      <div class="greek-card"><span class="greek-name">GAMMA <span class="help" onclick="alert('Acceleration: Delta change per $1 move')">?</span></span><div id="g">--</div></div>
      <div class="greek-card"><span class="greek-name">THETA <span class="help" onclick="alert('Time Decay: Value lost per day')">?</span></span><div id="t">--</div></div>
      <div class="greek-card"><span class="greek-name">VEGA <span class="help" onclick="alert('Volatility Sensitivity: Per 1% IV change')">?</span></span><div id="v">--</div></div>
      <div class="greek-card"><span class="greek-name">RHO <span class="help" onclick="alert('Rate Sensitivity: Per 1% Treasury change')">?</span></span><div id="r">--</div></div>
    </div>
  </div>
</div>

<script>
const MASSIVE_KEY = "khT7kqtgtjpevl6jDgff0B0jPBr2gpqc";
const FINNHUB_KEY = "d6a41gpr01qsjlb9lhj0d6a41gpr01qsjlb9lhjg";
const PROXY = "https://corsproxy.io/?";

let payoffChart = null;
let cachedChain = null;

// CORE QUANT MATH
const normPDF = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
const normCDF = (x) => {
    const t = 1 / (1 + 0.2316419 * Math.abs(x));
    const d = 0.3989423 * Math.exp(-x * x / 2);
    let p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    return x > 0 ? 1 - p : p;
};

function runMonteCarlo(S, K, T, r, sigma, type, costBasis) {
    const iterations = 100000;
    let winCount = 0;
    const drift = (r - 0.5 * sigma * sigma) * T;
    const diffusion = sigma * Math.sqrt(T);
    for (let i = 0; i < iterations; i++) {
        const u = Math.random(), v = Math.random();
        const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        const st = S * Math.exp(drift + diffusion * z);
        const payoff = type === 'call' ? Math.max(0, st - K) : Math.max(0, K - st);
        if (payoff > costBasis) winCount++;
    }
    return (winCount / iterations) * 100;
}

// API SYNC
async function fetchMassiveLastTrade() {
    const sym = document.getElementById('symbol').value.toUpperCase();
    if(!sym) return;
    const res = await fetch(`https://api.massive.com/v2/last/trade/${sym}?apiKey=${MASSIVE_KEY}`).then(r => r.json());
    if(res.results) document.getElementById('stockPrice').value = res.results.p;
    
    const p = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${sym}&token=${FINNHUB_KEY}`).then(r => r.json());
    if(p.logo) { document.getElementById('stockLogo').src = p.logo; document.getElementById('stockLogo').style.display='block'; }
    document.getElementById('companyName').textContent = p.name || "";
}

async function getMassiveSnapshot() {
    const sym = document.getElementById('symbol').value.toUpperCase();
    if(cachedChain) return cachedChain;
    const res = await fetch(`https://api.massive.com/v3/snapshot/options/${sym}?apiKey=${MASSIVE_KEY}`).then(r => r.json());
    const data = {};
    res.results.forEach(o => {
        const d = o.details;
        if(!data[d.expiration_date]) data[d.expiration_date] = { calls:[], puts:[] };
        data[d.expiration_date][d.contract_type+'s'].push({ strike: d.strike_price, iv: o.implied_volatility, price: o.last_quote.p });
    });
    cachedChain = data;
    return data;
}

async function pickMassiveExpiry() {
    const data = await getMassiveSnapshot();
    const overlay = createOverlay("Select Expiry");
    Object.keys(data).sort().forEach(exp => {
        const b = document.createElement('button');
        b.className="picker-btn"; b.innerText = exp;
        b.onclick = () => { document.getElementById('expiry').value = exp; updateDTE(exp); overlay.remove(); };
        overlay.firstChild.appendChild(b);
    });
}

async function pickMassiveStrike() {
    const exp = document.getElementById('expiry').value;
    if(!exp) return alert("Select expiry first");
    const data = await getMassiveSnapshot();
    const type = document.getElementById('type').value;
    const overlay = createOverlay("Select Strike");
    data[exp][type+'s'].sort((a,b)=>a.strike-b.strike).forEach(s => {
        const b = document.createElement('button');
        b.className="picker-btn"; b.innerText = `$${s.strike} (Mkt: $${s.price})`;
        b.onclick = () => { 
            document.getElementById('strike').value = s.strike;
            document.getElementById('currentPremium').value = s.price;
            document.getElementById('iv').value = (s.iv * 100).toFixed(2);
            overlay.remove(); 
        };
        overlay.firstChild.appendChild(b);
    });
}

// MACRO DATA (VIX / TNX)
async function fetchMacro() {
    try {
        const vx = await fetch(PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/^VIX`)).then(r => r.json());
        document.getElementById('vixVal').textContent = vx.chart.result[0].meta.regularMarketPrice.toFixed(2);
        const tx = await fetch(PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/^TNX`)).then(r => r.json());
        const rate = tx.chart.result[0].meta.regularMarketPrice;
        document.getElementById('tnxVal').textContent = rate.toFixed(3);
    } catch(e) {}
}

function runAnalysis() {
    const S = parseFloat(document.getElementById('stockPrice').value);
    const K = parseFloat(document.getElementById('strike').value);
    const iv = parseFloat(document.getElementById('iv').value)/100;
    const paid = parseFloat(document.getElementById('paidPremium').value);
    const r = parseFloat(document.getElementById('tnxVal').textContent)/100 || 0.045;
    const type = document.getElementById('type').value;
    const qty = parseInt(document.getElementById('qty').value);
    const T = (new Date(document.getElementById('expiry').value) - new Date())/31536000000;

    const prob = runMonteCarlo(S, K, T, r, iv, type, paid);
    document.getElementById('mcProb').innerText = prob.toFixed(3) + "%";
    
    const be = type === 'call' ? K + paid : K - paid;
    document.getElementById('resBreak').innerText = be.toFixed(2);
    document.getElementById('resCost').innerText = "$" + (paid * 100 * qty).toLocaleString();
    
    // BLACK-SCHOLES GREEKS & POP
    const d1 = (Math.log(S/K) + (r + 0.5*iv*iv)*T)/(iv*Math.sqrt(T));
    const d2 = d1 - (iv*Math.sqrt(T));
    
    document.getElementById('pop').innerText = (normCDF(type==='call' ? d2 : -d2)*100).toFixed(2) + "%";
    document.getElementById('d').innerText = (type==='call' ? normCDF(d1) : normCDF(d1)-1).toFixed(3);
    document.getElementById('g').innerText = (normPDF(d1) / (S * iv * Math.sqrt(T))).toFixed(4);
    document.getElementById('t').innerText = (-(S * normPDF(d1) * iv / (2 * Math.sqrt(T)) / 365)).toFixed(3);
    document.getElementById('v').innerText = (S * Math.sqrt(T) * normPDF(d1) / 100).toFixed(3);
    document.getElementById('r').innerText = ((type==='call'? K*T*Math.exp(-r*T)*normCDF(d2) : -K*T*Math.exp(-r*T)*normCDF(-d2))/100).toFixed(3);

    const sig = document.getElementById('executionSignal');
    sig.style.display='block';
    if(prob > 55) { sig.className='sig-green'; sig.innerText='PROCEED: HIGH PROBABILITY SETUP'; }
    else if(prob > 45) { sig.className='sig-yellow'; sig.innerText='CAUTION: NEUTRAL RISK'; }
    else { sig.className='sig-red'; sig.innerText='DO NOT EXECUTE: LOW PROBABILITY'; }

    document.getElementById('results').style.display='block';
    drawInteractiveChart(S, K, type, paid, iv, T, r, be, qty);
}

function drawInteractiveChart(S, K, type, paid, iv, T, r, be, qty) {
    const ctx = document.getElementById('payoffChart').getContext('2d');
    const labels = [], data = [];
    const step = (S*0.4)/60;
    for(let i=S*0.8; i<=S*1.2; i+=step) {
        labels.push(i.toFixed(2));
        const payoff = type==='call' ? Math.max(0, i-K) : Math.max(0, K-i);
        data.push((payoff - paid)*100*qty);
    }
    
    if(payoffChart) payoffChart.destroy();
    payoffChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Net Profit/Loss at Expiry', data, borderColor: '#28a745', backgroundColor:'rgba(40,167,69,0.1)', fill:true, pointRadius:0, borderWidth:3 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                annotation: {
                    annotations: {
                        priceLine: { type: 'line', xMin: findIdx(labels, S), xMax: findIdx(labels, S), borderColor: '#ffcc00', borderWidth: 2, label: { display:true, content:'Price', backgroundColor:'rgba(255,204,0,0.8)'} },
                        beLine: { type: 'line', xMin: findIdx(labels, be), xMax: findIdx(labels, be), borderColor: '#ff4d4d', borderDash:[5,5], label: { display:true, content:'BE'} }
                    }
                }
            },
            scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { color: 'rgba(255,255,255,0.05)' } } }
        }
    });
}

function findIdx(arr, val) {
    let closest = arr.reduce((a, b) => Math.abs(b - val) < Math.abs(a - val) ? b : a);
    return arr.indexOf(closest);
}

function createOverlay(t) {
    const d = document.createElement('div');
    d.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;display:flex;align-items:center;justify-content:center;";
    const b = document.createElement('div');
    b.style.cssText = "background:#1a1a1a;padding:25px;border-radius:15px;max-height:80vh;overflow-y:auto;width:350px;border:1px solid #333;";
    b.innerHTML = `<h3 style="margin-top:0; color:var(--primary);">${t}</h3>`;
    d.appendChild(b); document.body.appendChild(d);
    d.onclick = (e) => { if(e.target===d) d.remove(); };
    return d;
}

function updateDTE(d) {
    const diff = Math.ceil((new Date(d)-new Date())/86400000);
    document.getElementById('dteLabel').innerText = diff >= 0 ? `(${diff} Days Left)` : "(Expired)";
}

fetchMacro();
setInterval(() => { document.getElementById('vixTime').textContent = "Live Sync: " + new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
